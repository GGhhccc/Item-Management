<template>
  <u-skeleton rows="18" :loading="isLoading" title animate class="search-list">
    <view v-if="!isLoading">
      <!-- 总列表 -->
      <template>
        <view v-for="item in currentSearchList.itemList" :key="item.id">
          <SearchListItem
            :item-data="item"
            :is-checking="checkboxOperate"
            @onClick="chooseItem(item)"
            @longpress="showOperate"
            @setID="setID"
          />
        </view>
        <!-- 加载更多 -->
        <u-loadmore
          :status="loadMoreStatus"
          line
          loadingText="努力加载中，先喝杯茶"
          nomoreText="实在没有了"
          marginBottom="50rpx"
        />
      </template>
      <!-- 多选状态的弹出框 -->
      <CheckboxOperation
        :isLongpressing="checkboxOperate"
        :checkedId="currentSearchList.checkedItemList"
        @cancel="cancelChecking"
        @delete="deleteItem"
        @recover="recoverItem"
      />
      <PasswordPopup
        :popup="popup"
        @close="popup = false"
        @confirmGesture="confirmGesture"
        @confirmNumber="confirmNumber"
        :isValidate="true"
      />
    </view>
  </u-skeleton>
</template>

<script setup lang="ts">
import { useSearchStore } from '@/stores/search'
import { useFormStore } from '@/stores/form'
import { onReachBottom } from '@dcloudio/uni-app'
import { storeToRefs } from 'pinia'
import { ref, computed, toRefs, inject, watch } from 'vue'
import type { ItemList } from '@/types/search'
const searchStore = useSearchStore()
const { currentSearchList, currentScreenData, currentSearchInputData } = storeToRefs(searchStore)
const {
  fetchNewSearchList,
  fetchScreenSearchList,
  searchItemByInput,
  batchDeteleSearch,
  restoreDeletedItem,
  fetchHistoryItem
} = searchStore
const useForm = useFormStore()
const { fetchItemDetail, fetchRoomDetail } = useForm
// 是否是删除页面
const isDeleted = inject<boolean>('isDetele', false)
const isHistory = inject<boolean>('isHistory', false)

const props = defineProps<{
  isLoading: boolean
  manualDisable: boolean
  cancelMultiple: boolean
}>()

const { isLoading } = toRefs(props)
const manualDisable = ref(props.manualDisable)

// 取消多选状态
watch(
  () => props.cancelMultiple,
  () => {
    checkboxOperate.value = false
  }
)

//密码弹窗
const popup = ref(false)
const tempID = ref(0)
const tempType = ref(0)
async function setID(id: number, type: number, privacy: number): Promise<void> {
  if (privacy) {
    tempID.value = id
    tempType.value = type
    popup.value = true
  } else {
    if (type) await fetchItemDetail(id, '')
    else await fetchRoomDetail(id, '')
    uni.navigateTo({
      url: `/pages/details/details`
    })
  }
}
//验证手势密码
async function confirmGesture(password: number) {
  popup.value = false
  if (tempType.value) await fetchItemDetail(tempID.value, password.toString())
  else await fetchRoomDetail(tempID.value, password.toString())
  uni.navigateTo({
    url: `/pages/details/details`
  })
}
//验证数字密码
async function confirmNumber(password: number) {
  popup.value = false
  if (tempType.value) await fetchItemDetail(tempID.value, password.toString())
  else await fetchRoomDetail(tempID.value, password.toString())
  uni.navigateTo({
    url: `/pages/details/details`
  })
}

// 是否正在加载更多通知
const isLoadingMore = ref(false)

// 是否无法加载更多了
const loadMoreStatus = ref('')
const isNoMore = computed(
  () =>
    currentSearchList.value.itemList.length < currentSearchList.value.limit ||
    (currentSearchList.value.itemList.length &&
      currentSearchList.value.itemList.length === currentSearchList.value.total)
)

// 触底加载更多
onReachBottom(async () => {
  if (!isNoMore.value) {
    loadMoreStatus.value = 'loading'
    await loadMoreItem()
  } else {
    loadMoreStatus.value = 'nomore'
  }
})

// 请求更多
async function loadMoreItem() {
  isLoadingMore.value = true
  manualDisable.value = true

  try {
    if (currentScreenData.value.offset) {
      isDeleted ? await fetchScreenSearchList(1) : await fetchScreenSearchList(0)
    } else if (currentSearchInputData.value.offset) {
      isDeleted ? await searchItemByInput(1) : await searchItemByInput(0)
    } else {
      isHistory
        ? fetchHistoryItem('')
        : isDeleted
        ? await fetchNewSearchList(1)
        : await fetchNewSearchList(0)
    }
    manualDisable.value = false
  } catch {
    manualDisable.value = true
  } finally {
    isLoadingMore.value = false
  }
}

// 多选操作
const checkboxOperate = ref(false)

const showOperate = () => {
  checkboxOperate.value = true
}

// 点击
const chooseItem = (item: ItemList) => {
  // 多选状态下点击选中
  if (checkboxOperate.value) {
    item.isChecked = !item.isChecked
  } else {
    // 非多选状态下跳转到详情页
    if (item.type) fetchItemDetail(item.id, '')
    else fetchRoomDetail(item.id, '')
    uni.navigateTo({
      url: `/pages/details/details`
    })
  }
}

// 删除
const deleteItem = async () => {
  await batchDeteleSearch(currentSearchList.value.checkedItemList)
  uni.showToast({
    title: '删除成功',
    icon: 'success'
  })
}

// 恢复
const recoverItem = async () => {
  await restoreDeletedItem(currentSearchList.value.checkedItemList)
  uni.showToast({
    title: '恢复成功',
    icon: 'success'
  })
}

// 取消多选
const cancelChecking = () => {
  checkboxOperate.value = false
  // 将所有属性的 isChecked 重置为 false
  for (let i = 0; i < currentSearchList.value.itemList.length; i++) {
    currentSearchList.value.itemList[i].isChecked = false
  }
}
</script>

<style lang="scss" scoped></style>
